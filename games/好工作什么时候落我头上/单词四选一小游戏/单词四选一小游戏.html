<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>æ—¥è¯­å•è¯å¤§ä½œæˆ˜</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #6EC4DB;
            --secondary: #FFB6B9;
            --accent: #A8E6CF;
            --text: #4A4A4A;
        }

        body {
            font-family: 'Comic Sans MS', 'Hiragino Kaku Gothic Pro', sans-serif;
            background: linear-gradient(135deg, #F0F7FF, #E6FFE9);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

       .container {
            width: 90%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin: 20px auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: var(--primary);
            font-size: 2.8rem;
            text-shadow: 2px 2px 0 #FFF;
            margin: 1rem 0;
            text-align: center;
        }

       .btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 2rem 0;
        }

       .btn {
            background: var(--primary);
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

       .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(110, 196, 219, 0.4);
        }

       .btn-secondary {
            background: var(--secondary);
        }

        /* æ¸¸æˆé¡µé¢ */
        #gamePage {
            display: none;
        }

       .word-display {
            font-size: 3rem;
            color: var(--primary);
            margin: 3rem 0;
            text-shadow: 2px 2px 0 #FFF;
            text-align: center; /* é¢˜ç›®å±…ä¸­ */
        }

       .options-container {
            display: grid;
            gap: 1.5rem;
            margin: 3rem 0;
        }

       .option-btn {
            background: #FFF;
            color: var(--text);
            padding: 1.5rem;
            border: 3px solid var(--primary);
            border-radius: 20px;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s;
        }

       .option-btn:hover {
            background: var(--accent);
        }

       .option-btn.selected {
            background: var(--secondary);
            color: white;
        }

        /* æ’è¡Œæ¦œ */
        #ranking {
            margin: 2rem 0;
            background: rgba(168, 230, 207, 0.2);
            border-radius: 15px;
            padding: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th,
        td {
            padding: 12px;
            border-bottom: 2px solid var(--accent);
            text-align: center;
        }

        /* è®¡æ—¶å™¨ */
       .timer {
            font-size: 1.5rem;
            color: var(--primary);
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px 24px;
            border-radius: 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

       .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            text-align: center;
        }

        /* æ§åˆ¶æ æ ·å¼ */
       .control-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        /* è¿”å›é¦–é¡µæŒ‰é’®æ ·å¼ */
        #returnHomeBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
        }
    </style>
</head>

<body>
    <!-- é¦–é¡µ -->
    <div class="container" id="homePage">
        <h1>ğŸŒæ—¥è¯­å•è¯å¤§ä½œæˆ˜ğŸŒ</h1>

        <div class="btn-group">
            <button class="btn" onclick="document.getElementById('wordFile').click()">
                ğŸ“š å¯¼å…¥å•è¯è¡¨
            </button>
            <button class="btn" onclick="document.getElementById('studentFile').click()">
                ğŸ‘¥ å¯¼å…¥å­¦ç”Ÿåå•
            </button>
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" onclick="startGame()">
                ğŸ® å¼€å§‹æ¸¸æˆ
            </button>
            <button class="btn btn-secondary" onclick="clearRanking()">
                ğŸ—‘ï¸ æ’è¡Œæ¦œæ¸…é›¶
            </button>
        </div>

        <div id="ranking">
            <h2>ğŸ† æ’è¡Œæ¦œ</h2>
            <table id="rankTable">
                <thead>
                    <tr>
                        <th>æ’å</th>
                        <th>å­¦ç”Ÿ</th>
                        <th>ç”¨æ—¶</th>
                        <th>æ­£ç¡®ç‡</th>
                    </tr>
                </thead>
                <tbody id="rankBody"></tbody>
            </table>
        </div>

        <input type="file" id="wordFile" accept=".xlsx,.csv,.txt,.json" onchange="handleFile(this, 'word')"
            hidden>
        <input type="file" id="studentFile" accept=".xlsx,.csv,.txt,.json" onchange="handleFile(this,'student')"
            hidden>
    </div>

    <!-- æ¸¸æˆè¯´æ˜åŒºåŸŸ -->
    <div id="game-desc" style="width:75%;margin:2rem auto 0 auto;text-align:left;">
        <h3 style="text-align:center;">æ¸¸æˆè¯´æ˜</h3>
        <p>
            æœ¬æ¸¸æˆä¸ºæ—¥è¯­å•è¯å››é€‰ä¸€å°æ¸¸æˆã€‚å¯¼å…¥å•è¯è¡¨å’Œå­¦ç”Ÿåå•åï¼Œç³»ç»Ÿä¼šéšæœºæŠ½å–å•è¯ä½œä¸ºé¢˜ç›®ï¼Œå­¦ç”Ÿéœ€åœ¨å››ä¸ªé€‰é¡¹ä¸­é€‰æ‹©æ­£ç¡®çš„ä¸­æ–‡é‡Šä¹‰ã€‚<br>
            æ”¯æŒé”™é¢˜å¯¼å‡ºã€æ’è¡Œæ¦œç­‰åŠŸèƒ½ï¼Œé€‚åˆæ—¥è¯­è¯¾å ‚æµ‹éªŒå’Œè‡ªæµ‹ç»ƒä¹ ã€‚
        </p>
    </div>

    <!-- æ¸¸æˆé¡µé¢ -->
    <div class="container" id="gamePage">
        <div class="word-display" id="currentWord"></div>
        <div class="options-container" id="options"></div>
        <div class="control-bar">
            <button class="btn" onclick="prevQuestion()">â®ï¸ ä¸Šä¸€é¢˜</button>
            <button class="btn" onclick="togglePause()">â¯ï¸ æš‚åœ</button>
            <button class="btn" onclick="nextQuestion()">â­ï¸ ä¸‹ä¸€é¢˜</button>
        </div>
        <button class="btn btn-secondary" id="returnHomeBtn" onclick="returnHome()">ğŸ  è¿”å›é¦–é¡µ</button>
        <div class="timer" id="timer">00:00</div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="studentModal" class="modal">
        <h2>ğŸ‰ å½“å‰ç©å®¶ï¼š<span id="studentName"></span></h2>
        <button class="btn" onclick="startGamePage()">ç¡®å®š</button>
    </div>

    <div id="endModal" class="modal">
        <h2>ğŸ‰ æ¸¸æˆç»“æŸï¼</h2>
        <p>ç”¨æ—¶ï¼š<span id="finalTime"></span></p>
        <p>æ­£ç¡®ç‡ï¼š<span id="accuracyRate"></span>%</p>
        <div class="btn-group">
            <button class="btn" onclick="exportWrong()">ğŸ“¤ å¯¼å‡ºé”™é¢˜</button>
            <button class="btn" onclick="returnHome()">ğŸ  è¿”å›é¦–é¡µ</button>
        </div>
    </div>

    <!-- æµ®åŠ¨ä¸‹è½½æŒ‰é’®åŒºåŸŸ -->
    <div style="position:fixed;right:2vw;bottom:2vw;z-index:999;display:flex;flex-direction:column;gap:0.7rem;">
        <a href="å•è¯æµ‹è¯•ä¸­æ—¥ .csv" download class="start-button">å•è¯ä¸­æ—¥æ¨¡æ¿</a>
        <a href="å­¦ç”Ÿå§“å .csv" download class="start-button">å­¦ç”Ÿå§“åæ¨¡æ¿</a>
        <a href="å•è¯æµ‹è¯•æ—¥ä¸­ .csv" download class="start-button">å•è¯æ—¥ä¸­æ¨¡æ¿</a>
    </div>

    <script>
        let words = [];
        let students = [];
        let currentIndex = 0;
        let wrongAnswers = [];
        let timer;
        let startTime;
        let isPaused = false;
        let totalTime = 0;
        let currentStudent = '';
        let rankList = [];
        // ç”¨äºè®°å½•å·²ä½¿ç”¨çš„é¢˜ç›®ç´¢å¼•
        let usedIndices = [];
        // ç”¨äºè®°å½•æ¯é“é¢˜çš„é€‰æ‹©æƒ…å†µï¼Œæ ¼å¼ä¸º {questionIndex: selectedAnswer}
        let selectedOptions = {};
        // ç”¨äºå­˜å‚¨æ¯é“é¢˜çš„é€‰é¡¹é¡ºåº
        let optionOrders = {};

        // é¡µé¢åŠ è½½æ—¶å°è¯•æ¢å¤æ¸¸æˆçŠ¶æ€
        window.onload = function () {
            const savedState = localStorage.getItem('gameState');
            if (savedState) {
                const { words, students, currentIndex, wrongAnswers, startTime, isPaused, totalTime, currentStudent, rankList, usedIndices, selectedOptions, optionOrders } = JSON.parse(savedState);
                this.words = words;
                this.students = students;
                this.currentIndex = currentIndex;
                this.wrongAnswers = wrongAnswers;
                this.startTime = startTime;
                this.isPaused = isPaused;
                this.totalTime = totalTime;
                this.currentStudent = currentStudent;
                this.rankList = rankList;
                this.usedIndices = usedIndices;
                this.selectedOptions = selectedOptions;
                this.optionOrders = optionOrders;

                if (document.getElementById('gamePage').style.display === 'block') {
                    if (!isPaused) {
                        timer = setInterval(updateTimer, 1000);
                    }
                    showQuestion();
                }
            }
        }

        // ä¿å­˜æ¸¸æˆçŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
        function saveGameState() {
            const gameState = {
                words,
                students,
                currentIndex,
                wrongAnswers,
                startTime,
                isPaused,
                totalTime,
                currentStudent,
                rankList,
                usedIndices,
                selectedOptions,
                optionOrders
            };
            localStorage.setItem('gameState', JSON.stringify(gameState));
        }

        // æ–‡ä»¶å¤„ç†
        function handleFile(input, type) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onerror = function () {
                alert('è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼å’Œæƒé™ã€‚');
            };

            reader.onload = function (e) {
                const data = e.target.result;
                try {
                    if (file.name.endsWith('.xlsx')) {
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const result = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        if (type === 'word') words = result;
                        else students = result.map(s => s.å§“å || s.name);
                    } else if (file.name.endsWith('.json')) {
                        const jsonData = JSON.parse(data);
                        if (type === 'word') words = jsonData;
                        else students = jsonData.map(s => s.å§“å || s.name);
                    } else {
                        const text = data.split('\n').map(line => line.trim());
                        if (type === 'word') {
                            words = [];
                            text.forEach(line => {
                                const parts = line.split(/[,\t]/);
                                if (parts.length >= 2) {
                                    const [japanese, chinese] = parts;
                                    words.push({ japanese, chinese });
                                }
                            });
                        } else {
                            students = text.filter(line => line.length > 0);
                        }
                    }
                    alert('ğŸ‰ å¯¼å…¥æˆåŠŸï¼');
                    saveGameState();
                } catch (error) {
                    alert(`è§£ææ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼š${error.message}`);
                }
            };

            if (file.name.endsWith('.xlsx')) {
                reader.readAsBinaryString(file);
            } else {
                reader.readAsText(file);
            }
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            if (words.length === 0 || students.length === 0) {
                alert('è¯·å…ˆå¯¼å…¥å•è¯è¡¨å’Œå­¦ç”Ÿåå•ï¼');
                return;
            }
            currentStudent = students[Math.floor(Math.random() * students.length)];
            document.getElementById('studentName').textContent = currentStudent;
            showModal('studentModal');
            var desc = document.getElementById('game-desc');
            if(desc) desc.style.display = 'none';
        }

        // å¼€å§‹æ¸¸æˆé¡µé¢
        function startGamePage() {
            document.getElementById('studentModal').style.display = 'none';
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('gamePage').style.display = 'block';

            // é‡ç½®æ¸¸æˆçŠ¶æ€
            currentIndex = 0;
            wrongAnswers = [];
            totalTime = 0;
            isPaused = false;
            usedIndices = [];
            selectedOptions = {};
            optionOrders = {};

            startTime = Date.now();
            clearInterval(timer);
            timer = setInterval(updateTimer, 1000);
            showQuestion();
            saveGameState();
        }

        // æ˜¾ç¤ºé¢˜ç›®
        function showQuestion() {
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é¢˜ç›®éƒ½å·²ä½¿ç”¨
            if (usedIndices.length === words.length) {
                endGame();
                return;
            }

            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * words.length);
            } while (usedIndices.includes(randomIndex));

            usedIndices.push(randomIndex);
            currentIndex = usedIndices.length - 1;

            const currentWord = words[randomIndex];
            document.getElementById('currentWord').textContent = currentWord.japanese;

            const options = document.getElementById('options');
            options.innerHTML = '';

            // ç”Ÿæˆé€‰é¡¹
            let answerArray;
            if (optionOrders[randomIndex]) {
                answerArray = optionOrders[randomIndex];
            } else {
                const answers = new Set([currentWord.chinese]);
                const maxAttempts = 100;
                let attempts = 0;

                while (answers.size < 4 && attempts < maxAttempts) {
                    const randomWord = words[Math.floor(Math.random() * words.length)].chinese;
                    answers.add(randomWord);
                    attempts++;
                }

                // ç¡®ä¿æœ‰4ä¸ªé€‰é¡¹
                answerArray = Array.from(answers);
                while (answerArray.length < 4) {
                    const additionalWord = words[Math.floor(Math.random() * words.length)].chinese;
                    answerArray.push(additionalWord);
                }

                // éšæœºæ’åº
                answerArray.sort(() => Math.random() - 0.5);
                optionOrders[randomIndex] = answerArray;
            }

            // åˆ›å»ºé€‰é¡¹æŒ‰é’®
            answerArray.forEach(answer => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = answer;
                button.onclick = () => {
                    const currentQuestionIndex = usedIndices[currentIndex];
                    selectedOptions[currentQuestionIndex] = answer;
                    const optionButtons = document.querySelectorAll('.option-btn');
                    optionButtons.forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    button.classList.add('selected');
                    checkAnswer(answer, currentWord.chinese);
                    saveGameState();
                };
                const currentQuestionIndex = usedIndices[currentIndex];
                if (selectedOptions[currentQuestionIndex] === answer) {
                    button.classList.add('selected');
                }
                options.appendChild(button);
            });
            saveGameState();
        }

        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer(selectedAnswer, correctAnswer) {
            const currentQuestionIndex = usedIndices[currentIndex];
            if (selectedAnswer!== correctAnswer) {
                wrongAnswers.push(words[currentQuestionIndex]);
            }
            currentIndex++;
            if (usedIndices.length === words.length) {
                endGame();
            } else {
                showQuestion();
            }
            saveGameState();
        }

        // è¿”å›é¦–é¡µ
        function returnHome() {
            document.getElementById('homePage').style.display = 'block';
            document.getElementById('gamePage').style.display = 'none';
            document.getElementById('studentModal').style.display = 'none';
            document.getElementById('endModal').style.display = 'none';
            clearInterval(timer);

            // è®°å½•æˆç»©
            if (currentIndex > 0) {
                const accuracy = Math.round(
                    ((currentIndex - wrongAnswers.length) / currentIndex) * 100
                );
                rankList.push({
                    name: currentStudent,
                    time: totalTime,
                    accuracy: accuracy
                });
                updateRanking();
            }
            saveGameState();
        }

        // æ›´æ–°æ’è¡Œæ¦œ
        function updateRanking() {
            const tbody = document.getElementById('rankBody');
            tbody.innerHTML = '';

            rankList.sort((a, b) => a.time - b.time);

            rankList.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>${formatTime(item.time)}</td>
                    <td>${item.accuracy}%</td>
                `;
                tbody.appendChild(tr);
            });
            saveGameState();
        }

        // æ¸…ç©ºæ’è¡Œæ¦œ
        function clearRanking() {
            rankList = [];
            updateRanking();
            saveGameState();
        }

        // ç»“æŸæ¸¸æˆ
        function endGame() {
            clearInterval(timer);
            const accuracy = Math.round(
                ((currentIndex - wrongAnswers.length) / currentIndex) * 100
            );
            document.getElementById('finalTime').textContent = formatTime(totalTime);
            document.getElementById('accuracyRate').textContent = accuracy;
            showModal('endModal');
            saveGameState();
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        // éšè—æ¨¡æ€æ¡†
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // æš‚åœæ¸¸æˆ
        function togglePause() {
            const pauseButton = document.querySelector('button[onclick="togglePause()"]');
            if (isPaused) {
                startTime = Date.now() - totalTime;
                timer = setInterval(updateTimer, 1000);
                isPaused = false;
                pauseButton.textContent = 'â¯ï¸ æš‚åœ';
            } else {
                clearInterval(timer);
                totalTime = Date.now() - startTime;
                isPaused = true;
                pauseButton.textContent = 'â–¶ï¸ å¼€å§‹';
            }
            saveGameState();
        }

        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            if (!isPaused) {
                totalTime = Date.now() - startTime;
                document.getElementById('timer').textContent = formatTime(totalTime);
            }
            saveGameState();
        }

        // æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // å¯¼å‡ºé”™é¢˜
        function exportWrong() {
            try {
                if (wrongAnswers.length === 0) {
                    alert('æ²¡æœ‰é”™é¢˜å¯å¯¼å‡ºï¼');
                    return;
                }
                const csvContent = wrongAnswers.map(item => `${item.japanese},${item.chinese}`).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'wrong_answers.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                alert(`å¯¼å‡ºé”™é¢˜æ—¶å‘ç”Ÿé”™è¯¯ï¼š${error.message}`);
            }
        }

        // ä¸Šä¸€é¢˜
        function prevQuestion() {
            if (currentIndex === 0) {
                alert('æ²¡æœ‰ä¸Šä¸€é¢˜å•¦ï¼');
                return;
            }
            currentIndex--;
            const prevIndex = usedIndices[currentIndex];
            const currentWord = words[prevIndex];
            document.getElementById('currentWord').textContent = currentWord.japanese;

            const options = document.getElementById('options');
            options.innerHTML = '';

            const answerArray = optionOrders[prevIndex];

            // åˆ›å»ºé€‰é¡¹æŒ‰é’®
            answerArray.forEach(answer => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = answer;
                button.onclick = () => {
                    const currentQuestionIndex = usedIndices[currentIndex];
                    selectedOptions[currentQuestionIndex] = answer;
                    const optionButtons = document.querySelectorAll('.option-btn');
                    optionButtons.forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    button.classList.add('selected');
                    checkAnswer(answer, currentWord.chinese);
                    saveGameState();
                };
                if (selectedOptions[prevIndex] === answer) {
                    button.classList.add('selected');
                }
                options.appendChild(button);
            });
            saveGameState();
        }

        // ä¸‹ä¸€é¢˜
        function nextQuestion() {
            if (usedIndices.length === words.length && currentIndex === usedIndices.length - 1) {
                alert('å·²ç»æ˜¯æœ€åä¸€é¢˜å•¦ï¼');
                return;
            }
            currentIndex++;
            if (currentIndex < usedIndices.length) {
                const nextIndex = usedIndices[currentIndex];
                const currentWord = words[nextIndex];
                document.getElementById('currentWord').textContent = currentWord.japanese;

                const options = document.getElementById('options');
                options.innerHTML = '';

                const answerArray = optionOrders[nextIndex];

                // åˆ›å»ºé€‰é¡¹æŒ‰é’®
                answerArray.forEach(answer => {
                    const button = document.createElement('button');
                    button.className = 'option-btn';
                    button.textContent = answer;
                    button.onclick = () => {
                        const currentQuestionIndex = usedIndices[currentIndex];
                        selectedOptions[currentQuestionIndex] = answer;
                        const optionButtons = document.querySelectorAll('.option-btn');
                        optionButtons.forEach(btn => {
                            btn.classList.remove('selected');
                        });
                        button.classList.add('selected');
                        checkAnswer(answer, currentWord.chinese);
                        saveGameState();
                    };
                    if (selectedOptions[nextIndex] === answer) {
                        button.classList.add('selected');
                    }
                    options.appendChild(button);
                });
            } else {
                showQuestion();
            }
            saveGameState();
        }
    </script>
</body>

</html>
    